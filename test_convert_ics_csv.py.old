import csv
import re

def parse_ics(ics_file):
    """Parse un fichier ICS et extrait les événements avec leur statut de participation"""
    events = []
    with open(ics_file, "r", encoding="utf-8") as file:
        content = file.read()

    event_blocks = re.findall(r'BEGIN:VEVENT(.*?)END:VEVENT', content, re.DOTALL)

    for event in event_blocks:
        summary = re.search(r'SUMMARY:(.+)', event)
        start = re.search(r'DTSTART:(\d+T\d+Z?)', event)
        end = re.search(r'DTEND:(\d+T\d+Z?)', event)
 #       description = re.search(r'DESCRIPTION:(.+)', event)
 #       location = re.search(r'LOCATION:(.+)', event)
        partstat = re.search(r'PARTSTAT=(ACCEPTED|DECLINED|TENTATIVE|NEEDS-ACTION)', event)

        events.append({
            "Titre": summary.group(1) if summary else "",
            "Début": start.group(1) if start else "",
            "Fin": end.group(1) if end else "",
#            "Description": description.group(1) if description else "",
#            "Lieu": location.group(1) if location else "",
            "Statut": partstat.group(1) if partstat else "Inconnu"
        })
    
    return events

def export_csv(events, csv_file):
    """Exporte la liste d'événements en fichier CSV"""
    with open(csv_file, "w", newline="", encoding="utf-8") as file:
        writer = csv.DictWriter(file, fieldnames=["Titre", "Début", "Fin", "Description", "Lieu", "Statut"], delimiter=";")
        writer.writeheader()
        writer.writerows(events)

ics_file = "calendar.ics"  # Remplacez par votre fichier ICS
csv_file = "calendar.csv"  # Nom du fichier CSV généré

events = parse_ics(ics_file)
export_csv(events, csv_file)

print(f"✅ Conversion terminée ! Fichier CSV disponible : {csv_file}")
